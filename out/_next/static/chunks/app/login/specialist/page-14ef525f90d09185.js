(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[413],{6476:function(e,t,r){Promise.resolve().then(r.bind(r,7113))},7113:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return f}});var n=r(7437),i=r(2265),s=r(4033),a=r(7430),l=r(3067),o=r(4863),u=r(3023),c=r(1908),d=r(2621);function f(){let e=(0,s.useRouter)(),{signIn:t}=(0,o.a)(),{toast:r}=(0,d.pm)(),[f,h]=(0,i.useState)(!1),[v,g]=(0,i.useState)(""),[m,p]=(0,i.useState)(""),[w,x]=(0,i.useState)(!1);if((0,i.useEffect)(()=>{h(!0)},[]),!f)return null;let b=async n=>{n.preventDefault(),x(!0);try{await t(v,m,"specialist"),e.push("/dashboard/specialist")}catch(e){r({variant:"destructive",title:"Error",description:e.message})}finally{x(!1)}};return(0,n.jsx)("div",{className:"min-h-screen bg-background",children:(0,n.jsx)("div",{className:"max-w-md mx-auto pt-16 px-4",children:(0,n.jsxs)(a.E.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:"w-full overflow-hidden rounded-xl shadow-xl p-6 bg-card",children:[(0,n.jsxs)("div",{className:"mb-8",children:[(0,n.jsxs)(u.z,{variant:"ghost",onClick:()=>e.push("/"),className:"inline-flex items-center text-sm mb-6 text-muted-foreground hover:text-foreground",children:[(0,n.jsx)(l.Z,{className:"mr-2 h-4 w-4"}),"Back to Home"]}),(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold text-foreground",children:"Sleep Specialist Login"}),(0,n.jsx)("p",{className:"mt-2 text-muted-foreground",children:"Sign in to access your specialist dashboard"})]})]}),(0,n.jsxs)("form",{onSubmit:b,className:"space-y-6",children:[(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Email"}),(0,n.jsx)(c.I,{type:"email",value:v,onChange:e=>g(e.target.value),required:!0,disabled:w})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium mb-1 text-foreground",children:"Password"}),(0,n.jsx)(c.I,{type:"password",value:m,onChange:e=>p(e.target.value),required:!0,disabled:w})]}),(0,n.jsx)(u.z,{type:"submit",disabled:w,className:"w-full",children:w?"Signing in...":"Sign In"})]}),(0,n.jsx)("div",{className:"mt-6 text-center",children:(0,n.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Want to become a sleep specialist?"," ",(0,n.jsx)(u.z,{variant:"link",onClick:()=>e.push("/register/specialist"),className:"font-medium text-primary hover:underline p-0",children:"Register here"})]})})]})})})}},4863:function(e,t,r){"use strict";r.d(t,{a:function(){return o}});var n=r(2265),i=r(4660),s=r(6763),a=r(9311);let l=(0,i.Ue)(e=>({user:null,session:null,role:null,loading:!1,error:null,signIn:async(t,r,n)=>{try{var i,l;e({loading:!0,error:null}),a.f.info("Starting sign in process",{email:t,role:n});let{data:o,error:u}=await s.OQ.rpc("check_user_exists",{p_email:t});if(u)throw u;if(!o)throw Error("No account found with this email");let{data:c,error:d}=await s.OQ.auth.signInWithPassword({email:t,password:r});if(d)throw d;let f=(null===(l=c.user)||void 0===l?void 0:null===(i=l.user_metadata)||void 0===i?void 0:i.role)||n;if(a.f.info("Sign in successful",{userId:c.user.id,role:f}),"specialist"===f||"caregiver"===f){let{error:e}=await s.OQ.rpc("ensure_specialist_record_exists",{p_user_id:c.user.id});if(e)throw e;a.f.info("Profile record ensured",{role:f})}let h=3;for(;h>0;)try{break}catch(e){throw a.f.warn("Profile check failed, retrying...",{retries:h}),await new Promise(e=>setTimeout(e,1e3)),h--,e}e({user:c.user,session:c.session,role:f,loading:!1,error:null})}catch(t){throw a.f.error("Sign in failed",t),e({error:t instanceof Error?t.message:"An unknown error occurred",loading:!1,user:null,session:null,role:null}),t}},refreshAuth:async()=>{try{let n=await (0,s.dx)();if(n){var t,r;let i=null===(r=n.user)||void 0===r?void 0:null===(t=r.user_metadata)||void 0===t?void 0:t.role;e({user:n.user,session:n,role:i,loading:!1,error:null})}}catch(t){e({error:"Failed to refresh session",loading:!1})}},signOut:async()=>{try{a.f.info("Starting sign out"),e({loading:!0,error:null}),await s.OQ.auth.signOut(),e({user:null,session:null,role:null,loading:!1,error:null})}catch(t){throw a.f.error("Sign out failed",t),e({error:"Failed to sign out",loading:!1}),t}},clearError:()=>e({error:null})}));function o(){let{user:e,session:t,role:r,loading:i,error:a,signOut:o,clearError:u,refreshAuth:c}=l();(0,n.useEffect)(()=>{s.OQ.auth.getSession().then(e=>{var t,r,n;let{data:{session:i}}=e,s=null==i?void 0:null===(r=i.user)||void 0===r?void 0:null===(t=r.user_metadata)||void 0===t?void 0:t.role;l.setState({user:null!==(n=null==i?void 0:i.user)&&void 0!==n?n:null,session:i,role:s,loading:!1})});let{data:{subscription:e}}=s.OQ.auth.onAuthStateChange((e,t)=>{var r,n,i;let s=null==t?void 0:null===(n=t.user)||void 0===n?void 0:null===(r=n.user_metadata)||void 0===r?void 0:r.role;l.setState({user:null!==(i=null==t?void 0:t.user)&&void 0!==i?i:null,session:t,role:s,loading:!1,error:null})});return()=>e.unsubscribe()},[]),(0,n.useEffect)(()=>{if(!t)return;let e=async()=>{let e=await (0,s.z6)();e||await c()},r=setInterval(e,6e4);return()=>clearInterval(r)},[t,c]);let d=async(e,t,r)=>{try{var n,i;l.setState({loading:!0,error:null});let{data:a,error:o}=await s.OQ.rpc("check_user_exists",{p_email:e});if(o)throw o;if(!a)throw Error("No account found with this email");let{data:u,error:c}=await s.OQ.auth.signInWithPassword({email:e,password:t});if(c)throw c;let d=(null===(i=u.user)||void 0===i?void 0:null===(n=i.user_metadata)||void 0===n?void 0:n.role)||r;if("specialist"===d||"caregiver"===d){let{error:e}=await s.OQ.rpc("specialist"===d?"ensure_specialist_record_exists":"ensure_caregiver_exists",{p_user_id:u.user.id});if(e)throw e}let f=3;for(;f>0;)try{let{data:e}=await s.OQ.from("specialist"===d?"specialists":"caregivers").select("id").eq("auth_user_id",u.user.id).single();if(e)break;await new Promise(e=>setTimeout(e,1e3)),f--}catch(e){if(console.error("Profile check failed, retrying...",e),f--,0===f)throw e}l.setState({user:u.user,session:u.session,role:d,loading:!1,error:null})}catch(e){throw l.setState({error:e instanceof Error?e.message:"An unknown error occurred",loading:!1,user:null,session:null,role:null}),e}};return{user:e,session:t,loading:i,role:r,error:a,signIn:d,signOut:o,clearError:u,refreshAuth:c}}},9808:function(e,t,r){"use strict";/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var n=r(2265),i="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=n.useState,a=n.useEffect,l=n.useLayoutEffect,o=n.useDebugValue;function u(e){var t=e.getSnapshot;e=e.value;try{var r=t();return!i(e,r)}catch(e){return!0}}var c="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var r=t(),n=s({inst:{value:r,getSnapshot:t}}),i=n[0].inst,c=n[1];return l(function(){i.value=r,i.getSnapshot=t,u(i)&&c({inst:i})},[e,r,t]),a(function(){return u(i)&&c({inst:i}),e(function(){u(i)&&c({inst:i})})},[e]),o(r),r};t.useSyncExternalStore=void 0!==n.useSyncExternalStore?n.useSyncExternalStore:c},3176:function(e,t,r){"use strict";/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var n=r(2265),i=r(6272),s="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},a=i.useSyncExternalStore,l=n.useRef,o=n.useEffect,u=n.useMemo,c=n.useDebugValue;t.useSyncExternalStoreWithSelector=function(e,t,r,n,i){var d=l(null);if(null===d.current){var f={hasValue:!1,value:null};d.current=f}else f=d.current;var h=a(e,(d=u(function(){function e(e){if(!o){if(o=!0,a=e,e=n(e),void 0!==i&&f.hasValue){var t=f.value;if(i(t,e))return l=t}return l=e}if(t=l,s(a,e))return t;var r=n(e);return void 0!==i&&i(t,r)?(a=e,t):(a=e,l=r)}var a,l,o=!1,u=void 0===r?null:r;return[function(){return e(t())},null===u?void 0:function(){return e(u())}]},[t,r,n,i]))[0],d[1]);return o(function(){f.hasValue=!0,f.value=h},[h]),c(h),h}},6272:function(e,t,r){"use strict";e.exports=r(9808)},5401:function(e,t,r){"use strict";e.exports=r(3176)},4660:function(e,t,r){"use strict";r.d(t,{Ue:function(){return f}});let n=e=>{let t;let r=new Set,n=(e,n)=>{let i="function"==typeof e?e(t):e;if(!Object.is(i,t)){let e=t;t=(null!=n?n:"object"!=typeof i||null===i)?i:Object.assign({},t,i),r.forEach(r=>r(t,e))}},i=()=>t,s={setState:n,getState:i,getInitialState:()=>a,subscribe:e=>(r.add(e),()=>r.delete(e)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),r.clear()}},a=t=e(n,i,s);return s},i=e=>e?n(e):n;var s=r(2265),a=r(5401);let{useDebugValue:l}=s,{useSyncExternalStoreWithSelector:o}=a,u=!1,c=e=>e,d=e=>{"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");let t="function"==typeof e?i(e):e,r=(e,r)=>(function(e,t=c,r){r&&!u&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),u=!0);let n=o(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,r);return l(n),n})(t,e,r);return Object.assign(r,t),r},f=e=>e?d(e):d}},function(e){e.O(0,[579,892,834,971,864,744],function(){return e(e.s=6476)}),_N_E=e.O()}]);